<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>iPhone Check â€“ Pin, MÃ n hÃ¬nh, FPS & Äá»™ giáº­t</title>
<style>
  :root{
    --bg:#0b0c10; --panel:#0f1320; --text:#e6edf7; --muted:#9aa6bf; --accent:#22d3ee; --ok:#34d399; --warn:#f59e0b; --bad:#ef4444; --border:#1f2937;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 800px at 10% -10%,#13203a33,transparent),radial-gradient(1000px 700px at 110% 110%,#1a163333,transparent),var(--bg);color:var(--text);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial}
  h1,h2{margin:0 0 .5rem}
  h1{font-size:clamp(20px,3.2vw,28px)}
  h2{font-size:clamp(18px,2.6vw,22px)}
  p{color:var(--muted)}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px}
  .card{background:linear-gradient(180deg,#0f1320,#0c1020);border:1px solid var(--border);border-radius:16px;padding:16px;margin:16px 0;box-shadow:0 6px 24px #00000033}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .btn{appearance:none;border:1px solid var(--border);background:#12182a;color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
  .btn:hover{border-color:#2a3a5a}
  .btn[aria-pressed="true"]{outline:2px solid var(--accent)}
  .tag{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted);font-size:12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .kbd{padding:2px 6px;border:1px solid var(--border);border-bottom-width:2px;border-radius:6px;background:#0b0f1c;font:12px ui-monospace,SFMono-Regular;}
  .small{font-size:12px;color:var(--muted)}
  .meter{height:10px;border-radius:999px;background:#0c1222;border:1px solid var(--border);overflow:hidden}
  .meter>i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--ok),var(--warn),var(--bad));transition:width .2s}
  .pill{display:inline-block;background:#0d152a;border:1px solid var(--border);padding:6px 10px;border-radius:999px}
  .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .right{margin-left:auto}
  .fs{position:fixed;inset:0;background:#000;display:none;z-index:99}
  .fs.show{display:block}
  .fs .pad{position:absolute;inset:0;display:grid;place-items:center}
  .fish-tank{position:relative;width:100%;height:300px;border:1px solid var(--border);border-radius:12px;background:linear-gradient(180deg,#0a1a3a 0%,#051020 50%,#020810 100%);overflow:hidden;cursor:pointer}
  .fish{position:absolute;font-size:32px;transition:transform 0.1s linear;pointer-events:none;user-select:none}
  .color-chip{width:42px;height:28px;border-radius:8px;border:1px solid var(--border);cursor:pointer}
  .colors{display:flex;gap:10px;flex-wrap:wrap}
  .test-surface{height:160px;border:1px dashed #2a3555;border-radius:12px;background:#0b0f1c;display:grid;place-items:center}
  canvas{max-width:100%;border-radius:12px;border:1px solid var(--border);background:#0b0f1c}
  .warn{color:var(--warn)}
  .danger{color:var(--bad)}
  .ok{color:var(--ok)}
  @media (max-width:740px){.row,.row-3{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="wrap">
    <header class="card" style="position:sticky;top:8px;z-index:5;background:#0f1320cc;backdrop-filter:blur(8px)">
      <div class="flex">
        <div>
          <h1>iPhone Check</h1>
          <p class="small">Test pin (thá»§ cÃ´ng), mÃ n hÃ¬nh, FPS/Hz quan sÃ¡t vÃ  Ä‘o <span class="tag">clientâ€‘side</span>, Ä‘Ã¡nh giÃ¡ Ä‘á»™ giáº­t khi táº£i náº·ng. KhÃ´ng yÃªu cáº§u cÃ i app.</p>
        </div>
        <div class="right flex">
          <button class="btn" id="btnFS">Cháº¿ Ä‘á»™ toÃ n mÃ n hÃ¬nh</button>
          <span class="pill" id="ua"></span>
        </div>
      </div>
    </header>

    <!-- PIN -->
    <section class="card" id="pin">
      <h2>1) Test Pin (Ä‘o tá»‘c Ä‘á»™ hao pin)</h2>
      <p id="pinDesc">Äang kiá»ƒm tra há»— trá»£ Ä‘á»c pin tá»± Ä‘á»™ng...</p>
      <div class="grid">
        <div>
          <div class="row">
            <label>Pin báº¯t Ä‘áº§u (%)<br><input id="pinStart" type="number" min="1" max="100" class="btn" style="width:100%" placeholder="vd: 95"></label>
            <label>Pin hiá»‡n táº¡i (%)<br><input id="pinNow" type="number" min="0" max="100" class="btn" style="width:100%" placeholder="vd: 90"></label>
          </div>
          <div class="flex" style="margin-top:10px">
            <button class="btn" id="pinStartBtn">Báº¯t Ä‘áº§u</button>
            <button class="btn" id="pinMarkBtn">Cáº­p nháº­t</button>
            <button class="btn" id="pinAutoBtn" style="display:none">Báº­t tá»± Ä‘á»™ng</button>
            <span class="pill mono" id="pinTimer">00:00:00</span>
          </div>
          <div class="small" id="pinStatus" style="margin-top:8px"></div>
        </div>
        <div>
          <div class="test-surface" id="pinAdvice">Báº­t 1 tÃ¡c vá»¥ cá»‘ Ä‘á»‹nh (xem video/treo mÃ n hÃ¬nh). Nháº­p % pin trong lÃºc cháº¡y Ä‘á»ƒ Æ°á»›c lÆ°á»£ng.</div>
          <div style="margin-top:10px">
            <div class="flex"><b>Tá»‘c Ä‘á»™ hao pin Æ°á»›c tÃ­nh:</b> <span class="right mono" id="pinRate">â€” %/giá»</span></div>
            <div class="meter" title="Tá»‘c Ä‘á»™ cao = hao pin nhanh"><i id="pinMeter"></i></div>
            <div class="small" id="pinNote">&nbsp;</div>
          </div>
        </div>
      </div>
    </section>

    <!-- MÃ€N HÃŒNH -->
    <section class="card" id="screen">
      <h2>2) Test MÃ n hÃ¬nh (mÃ u, Ä‘iá»ƒm cháº¿t, cáº£m á»©ng)</h2>
      <div class="colors" id="colorList"></div>
      <div class="flex" style="margin-top:10px">
        <button class="btn" id="btnChecker">Checkerboard</button>
        <button class="btn" id="btnGradient">Gradient</button>
        <button class="btn" id="btnTouch">Kiá»ƒm tra cáº£m á»©ng (váº½)</button>
        <button class="btn" id="btnExitView">ThoÃ¡t cháº¿ Ä‘á»™ test</button>
      </div>
      <p class="small">Máº¹o: báº­t <span class="kbd">Cháº¿ Ä‘á»™ toÃ n mÃ n hÃ¬nh</span> Ä‘á»ƒ soi Ä‘á»‘m sÃ¡ng/Ã¡m mÃ u; kÃ©o ngÃ³n tay váº½ kháº¯p mÃ n Ä‘á»ƒ tÃ¬m Ä‘iá»ƒm Ä‘Æ¡ cáº£m á»©ng. <b>Váº½:</b> 1 ngÃ³n = mÃ u xanh, 3 ngÃ³n = mÃ u Ä‘á». <b>ThoÃ¡t:</b> cháº¡m 3 ngÃ³n Ä‘Ãºp 2 láº§n hoáº·c báº¥m nÃºt "ThoÃ¡t cháº¿ Ä‘á»™ test".</p>
    </section>

    <!-- FPS / KHUNG HÃŒNH -->
    <section class="card" id="fps">
      <h2>3) FPS / Táº§n sá»‘ quÃ©t quan sÃ¡t</h2>
      <p>Äo FPS báº±ng <code>requestAnimationFrame</code> (quan sÃ¡t). Náº¿u iPhone há»— trá»£ 120Hz (ProMotion) vÃ  khÃ´ng bá»‹ giá»›i háº¡n, FPS quan sÃ¡t thÆ°á»ng â‰ˆ 120 á»Ÿ thao tÃ¡c cuá»™n/váº½. KhÃ´ng thá»ƒ Ã©p pháº§n cá»©ng Ä‘á»•i Hz tá»« web.</p>
      <div class="row">
        <div>
          <canvas id="fpsCanvas" width="600" height="200"></canvas>
          <div class="flex" style="margin-top:8px">
            <span>FPS hiá»‡n táº¡i: <b class="mono" id="fpsNow">â€”</b></span>
            <span class="pill">TB 2s: <b class="mono" id="fpsAvg">â€”</b></span>
            <span class="pill">Äá»‰nh: <b class="mono" id="fpsPeak">â€”</b></span>
            <span class="pill">Tháº¥p: <b class="mono" id="fpsLow">â€”</b></span>
            <span class="right small">Vuá»‘t / cuá»™n Ä‘á»ƒ quan sÃ¡t thay Ä‘á»•i</span>
          </div>
        </div>
        <div>
          <div class="flex" style="margin-bottom:8px">
            <button class="btn" id="btnStartFPS">Báº¯t Ä‘áº§u Ä‘o</button>
            <button class="btn" id="btnStopFPS">Dá»«ng</button>
            <button class="btn" id="btnSim60" aria-pressed="false">Giá»›i háº¡n (giáº£ láº­p) 60 FPS</button>
          </div>
          <div class="small">
            â€¢ <b>Giá»›i háº¡n (giáº£ láº­p) 60 FPS</b> chá»‰ lÃ m cháº­m vÃ²ng láº·p váº½ Ä‘á»ƒ báº¡n so sÃ¡nh cáº£m giÃ¡c cuá»™n/váº½, <u>khÃ´ng thay Ä‘á»•i táº§n sá»‘ quÃ©t pháº§n cá»©ng</u>.<br>
            â€¢ TrÃªn iOS: báº­t/táº¯t <b>CÃ i Ä‘áº·t â†’ Trá»£ nÄƒng â†’ Chuyá»ƒn Ä‘á»™ng â†’ Giá»›i háº¡n tá»‘c Ä‘á»™ khung hÃ¬nh</b> Ä‘á»ƒ kiá»ƒm tra tháº­t 60Hz/120Hz.
          </div>
        </div>
      </div>
    </section>

    <!-- THáº¢ CÃ -->
    <section class="card" id="fish">
      <h2>5) Tháº£ cÃ¡ (Fish Tank)</h2>
      <p>Cháº¡m vÃ o bá»ƒ cÃ¡ Ä‘á»ƒ tháº£ cÃ¡! CÃ¡ sáº½ bÆ¡i tá»± do trong bá»ƒ. Cháº¡m nhiá»u láº§n Ä‘á»ƒ cÃ³ nhiá»u cÃ¡ hÆ¡n.</p>
      <div class="flex" style="margin-bottom:10px">
        <button class="btn" id="btnClearFish">XÃ³a táº¥t cáº£ cÃ¡</button>
        <button class="btn" id="btnAutoFish" aria-pressed="false">Tá»± Ä‘á»™ng tháº£ cÃ¡</button>
        <span class="pill">Sá»‘ cÃ¡: <b class="mono" id="fishCount">0</b></span>
      </div>
      <div class="fish-tank" id="fishTank"></div>
      <p class="small">ğŸ’¡ Máº¹o: Báº­t tá»± Ä‘á»™ng tháº£ cÃ¡ Ä‘á»ƒ xem bá»ƒ cÃ¡ Ä‘áº§y Ä‘á»§. CÃ¡ sáº½ tá»± Ä‘á»™ng biáº¿n máº¥t sau má»™t thá»i gian.</p>
    </section>

    <!-- Äá»˜ GIáº¬T / JANK -->
    <section class="card" id="jank">
      <h2>6) Äá»™ lag/giáº­t khi táº£i náº·ng</h2>
      <p>Cháº¡y táº£i giáº£ láº­p (CPU) báº±ng Web Worker Ä‘á»ƒ quan sÃ¡t FPS vÃ  <b>Ä‘á»™ trá»… vÃ²ng láº·p</b>. Cao quÃ¡ â†’ dá»… giáº­t. KhÃ´ng thay tháº¿ Ä‘Æ°á»£c thá»­ nghiá»‡m Ä‘a á»©ng dá»¥ng tháº­t ngoÃ i Ä‘á»i, nhÆ°ng há»¯u Ã­ch Ä‘á»ƒ so sÃ¡nh tÆ°Æ¡ng Ä‘á»‘i.</p>
      <div class="row">
        <div>
          <div class="flex" style="gap:12px;align-items:center">
            <label> Má»©c táº£i (1â€“6): <input id="loadLevel" type="range" min="0" max="6" step="1" value="0" /></label>
            <button class="btn" id="btnStartLoad">Báº¯t Ä‘áº§u táº£i</button>
            <button class="btn" id="btnStopLoad">Dá»«ng táº£i</button>
          </div>
          <div style="margin-top:10px">
            <div class="flex"><b>Äá»™ trá»… vÃ²ng láº·p (ms)</b><span class="right mono" id="lagNow">â€”</span></div>
            <div class="meter" title="Cao = trá»… nhiá»u, dá»… giáº­t"><i id="lagMeter"></i></div>
            <div class="small">Quan sÃ¡t <b>FPS</b> bÃªn trÃªn khi tÄƒng táº£i; náº¿u FPS dao Ä‘á»™ng máº¡nh hoáº·c <span class="danger">tá»¥t sÃ¢u</span>, thiáº¿t bá»‹ Ä‘ang cÄƒng.
            </div>
          </div>
        </div>
        <div>
          <div class="grid">
            <div class="pill">Long Tasks: <span id="ltCount" class="mono">0</span></div>
            <div class="pill">Drift TB (ms): <span id="driftAvg" class="mono">â€”</span></div>
            <div class="pill">Peak drift (ms): <span id="driftPeak" class="mono">â€”</span></div>
          </div>
          <p class="small">* Long Task â‰¥ 50ms (náº¿u trÃ¬nh duyá»‡t há»— trá»£ <code>PerformanceObserver</code>). Drift = Ä‘á»™ lá»‡ch lá»‹ch thá»i gian, cao â†’ kháº£ nÄƒng jank.</p>
        </div>
      </div>
    </section>

    <footer class="card">
      <div class="grid">
        <div>
          <b>LÆ°u Ã½ quan trá»ng</b>
          <ul class="small">
            <li>Web khÃ´ng thá»ƒ Ä‘á»c <b>pháº§n trÄƒm pin</b> tháº­t trÃªn iOS (Apple cháº·n), nÃªn pháº§n Pin lÃ  Ä‘o <b>thá»§ cÃ´ng</b>.</li>
            <li>KhÃ´ng thá»ƒ Ã©p thay Ä‘á»•i <b>táº§n sá»‘ quÃ©t pháº§n cá»©ng</b> (Hz). Trang chá»‰ Ä‘o FPS quan sÃ¡t.</li>
            <li>Káº¿t quáº£ phá»¥ thuá»™c Ä‘á»™ sÃ¡ng, nhiá»‡t Ä‘á»™, á»©ng dá»¥ng ná»n, tÃ¬nh tráº¡ng pin.</li>
          </ul>
        </div>
        <div>
          <b>Máº¹o kiá»ƒm tra nhanh</b>
          <ul class="small">
            <li>Má»Ÿ tab tráº¯ng/Ä‘en Ä‘á»ƒ soi Ã¡m mÃ u, cháº¥m sÃ¡ng/Ä‘en, sá»c.</li>
            <li>Vuá»‘t liÃªn tá»¥c vÃ  nhÃ¬n Ä‘á»“ thá»‹ FPS; náº¿u <span class="danger">rÄƒng cÆ°a</span> máº¡nh â†’ kháº£ nÄƒng giáº­t.</li>
            <li>TÄƒng táº£i má»©c 4â€“6 rá»“i so FPS trÆ°á»›c/sau Ä‘á»ƒ cáº£m nháº­n.</li>
          </ul>
        </div>
      </div>
    </footer>
  </div>

  <!-- FULLSCREEN SURFACE FOR SCREEN TESTS -->
  <div class="fs" id="fs">
    <div class="pad" id="fsPad">
      <canvas id="draw" style="display:none;touch-action:none"></canvas>
    </div>
  </div>

<script>
  // ====== Utils ======
  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));
  const fmt = (n)=> (n===undefined||isNaN(n))?"â€”":(Math.round(n*10)/10).toString();
  const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
  const ua = navigator.userAgent;
  $('#ua').textContent = ua.split('(')[0].trim();

  // ====== Fullscreen helpers ======
  const fsEl = $('#fs');
  const fsPad = $('#fsPad');
  const canvasDraw = $('#draw');
  let drawing = false, ctx = null;
  function setFSColor(c){ fsPad.style.background = c; canvasDraw.style.display='none'; }
  function showFS(){ fsEl.classList.add('show'); }
  function hideFS(){ fsEl.classList.remove('show'); canvasDraw.style.display='none'; }
  $('#btnFS').onclick = ()=>{
    if(!document.fullscreenElement) document.documentElement.requestFullscreen?.(); else document.exitFullscreen?.();
  };
  $('#btnExitView').onclick = hideFS;

  // Build color chips
  const colors=[['Tráº¯ng','#ffffff'],['Äen','#000000'],['Äá»','#ff0000'],['Xanh lÃ¡','#00ff00'],['Xanh dÆ°Æ¡ng','#0000ff'],['XÃ¡m','#808080'],['VÃ ng','#ffff00'],['TÃ­m','#800080']];
  const colorList=$('#colorList');
  colors.forEach(([name,hex])=>{
    const d=document.createElement('button');
    d.className='color-chip'; d.style.background=hex; d.title=name;
    d.onclick=()=>{ setFSColor(hex); showFS(); };
    colorList.appendChild(d);
  });

  // Checkerboard & Gradient
  $('#btnChecker').onclick=()=>{ showFS(); setFSColor('repeating-conic-gradient(#000 0 25%, #fff 0 50%)'); };
  $('#btnGradient').onclick=()=>{ showFS(); setFSColor('linear-gradient(90deg,#000,#fff)'); };

  // Touch draw
  let drawMode = 'draw'; // 'draw' or 'erase'
  function resizeCanvas(){
    canvasDraw.width = window.innerWidth; canvasDraw.height = window.innerHeight; ctx = canvasDraw.getContext('2d'); ctx.lineWidth=8; ctx.lineCap='round'; ctx.strokeStyle='#22d3ee';
  }
  window.addEventListener('resize',()=>{ if(canvasDraw.style.display!=='none'){ resizeCanvas(); }});
  $('#btnTouch').onclick=()=>{ showFS(); canvasDraw.style.display='block'; resizeCanvas(); };
  function pos(e){ if(e.touches&&e.touches[0]) return {x:e.touches[0].clientX,y:e.touches[0].clientY}; return {x:e.clientX,y:e.clientY}; }
  
  // Track active touches
  let activeTouches = new Map();
  
  canvasDraw.addEventListener('pointerdown',e=>{
    const touchCount = e.touches ? e.touches.length : 1;
    if(touchCount === 1){
      drawing = true;
      drawMode = 'draw';
      ctx.globalCompositeOperation = 'source-over';
      ctx.strokeStyle = '#22d3ee';
      ctx.lineWidth = 8;
      ctx.beginPath();
      ctx.moveTo(pos(e).x, pos(e).y);
      activeTouches.set(e.pointerId, {mode: 'draw', startX: pos(e).x, startY: pos(e).y});
    }
  });
  
  canvasDraw.addEventListener('pointermove',e=>{
    if(!drawing) return;
    const touchCount = e.touches ? e.touches.length : 1;
    const touch = activeTouches.get(e.pointerId);
    
    if(touchCount === 1 && touch && touch.mode === 'draw'){
      const p = pos(e);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
    }
  });
  
  window.addEventListener('pointerup',(e)=>{
    activeTouches.delete(e.pointerId);
    if(activeTouches.size === 0) drawing = false;
  });
  
  // Exit gesture: 3 fingers double tap
  let lastThreeFingerTap = 0;
  function handleThreeFingerTap(e) {
    if (e.touches.length === 3) {
      const now = Date.now();
      if (now - lastThreeFingerTap < 500) { // Double tap within 500ms
        hideFS();
        lastThreeFingerTap = 0; // Reset
        return true; // Exit handled
      } else {
        lastThreeFingerTap = now;
      }
    } else {
      lastThreeFingerTap = 0; // Reset if not 3 fingers
    }
    return false;
  }
  fsPad.addEventListener('touchstart', handleThreeFingerTap);
  
  // Handle 3-finger drawing (red color) or exit
  let threeFingerStartTime = 0;
  canvasDraw.addEventListener('touchstart',(e)=>{
    if(e.touches.length === 3 && canvasDraw.style.display !== 'none'){
      // Check for exit gesture first
      if(handleThreeFingerTap(e)){
        e.preventDefault();
        return; // Exit, don't draw
      }
      // Otherwise, start 3-finger drawing
      threeFingerStartTime = Date.now();
      e.preventDefault();
      drawing = true;
      drawMode = 'draw3';
      ctx.globalCompositeOperation = 'source-over';
      ctx.strokeStyle = '#ef4444'; // Red color for 3 fingers
      ctx.lineWidth = 12; // Thicker for 3 fingers
      const touch = e.touches[0];
      ctx.beginPath();
      ctx.moveTo(touch.clientX, touch.clientY);
    }
  });
  
  canvasDraw.addEventListener('touchmove',(e)=>{
    if(e.touches.length === 3 && drawing && drawMode === 'draw3'){
      // Only draw if moved (not just tap)
      if(Date.now() - threeFingerStartTime > 100){
        e.preventDefault();
        const touch = e.touches[0];
        ctx.lineTo(touch.clientX, touch.clientY);
        ctx.stroke();
      }
    }
  });
  
  canvasDraw.addEventListener('touchend',(e)=>{
    if(e.touches.length < 3){
      drawing = false;
      drawMode = 'draw';
      threeFingerStartTime = 0;
    }
  });

  // ====== PIN drain test ======
  let pinStartTS=null; let pinTimerId=null; let battery=null; let pinAutoMode=false; let pinAutoInterval=null;
  
  // Check Battery API support
  async function initBattery(){
    if('getBattery' in navigator){
      try{
        battery = await navigator.getBattery();
        $('#pinDesc').innerHTML = 'âœ… <b>Äá»c pin tá»± Ä‘á»™ng Ä‘Æ°á»£c há»— trá»£!</b> Báº¥m "Báº­t tá»± Ä‘á»™ng" Ä‘á»ƒ tá»± Ä‘á»™ng cáº­p nháº­t pin. Hoáº·c nháº­p thá»§ cÃ´ng náº¿u muá»‘n.';
        $('#pinAutoBtn').style.display='inline-block';
        $('#pinStatus').textContent = `Pin: ${Math.round(battery.level*100)}% | Sáº¡c: ${battery.charging?'Äang sáº¡c':'KhÃ´ng sáº¡c'}`;
        
        battery.addEventListener('chargingchange',()=>{
          $('#pinStatus').textContent = `Pin: ${Math.round(battery.level*100)}% | Sáº¡c: ${battery.charging?'Äang sáº¡c':'KhÃ´ng sáº¡c'}`;
        });
        battery.addEventListener('levelchange',()=>{
          const pct = Math.round(battery.level*100);
          $('#pinStatus').textContent = `Pin: ${pct}% | Sáº¡c: ${battery.charging?'Äang sáº¡c':'KhÃ´ng sáº¡c'}`;
          if(pinAutoMode && pinStartTS){
            $('#pinNow').value = pct;
            refreshPin();
          }
        });
      }catch(e){
        $('#pinDesc').innerHTML = 'âš ï¸ KhÃ´ng thá»ƒ truy cáº­p pin. Vui lÃ²ng <b>nháº­p pháº§n trÄƒm pin thá»§ cÃ´ng</b> Ä‘á»ƒ tÃ­nh %/giá».';
      }
    }else{
      $('#pinDesc').innerHTML = 'âš ï¸ Safari iOS khÃ´ng cho truy cáº­p má»©c pin qua web. Vui lÃ²ng <b>nháº­p pháº§n trÄƒm pin thá»§ cÃ´ng</b> Ä‘á»ƒ tÃ­nh %/giá».';
    }
  }
  initBattery();
  
  function updatePinTimer(){ if(!pinStartTS) return; const s=Math.floor((Date.now()-pinStartTS)/1000); const h=String(Math.floor(s/3600)).padStart(2,'0'); const m=String(Math.floor(s%3600/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); $('#pinTimer').textContent=`${h}:${m}:${ss}`; }
  function computePinRate(){
    const a = parseFloat($('#pinStart').value);
    const b = parseFloat($('#pinNow').value);
    if(!pinStartTS || isNaN(a)||isNaN(b)||a<=b) return {rate:null, note:'Nháº­p Ä‘Ãºng sá»‘ vÃ  hao pin pháº£i > 0%'};
    const hrs = (Date.now()-pinStartTS)/3600000;
    const drop = a-b; const rate = drop/hrs; // % per hour
    return {rate, hrs, drop};
  }
  function refreshPin(){
    const {rate,hrs,drop} = computePinRate();
    const r = rate? rate: 0; $('#pinRate').textContent = rate? `${fmt(rate)} %/giá»` : 'â€” %/giá»';
    $('#pinMeter').style.width = `${clamp(r,0,25)/25*100}%`;
    let t='';
    if(rate){
      t = `Hao ${fmt(drop)}% trong ${fmt(hrs)} giá». ~${fmt(100/rate)} giá» tá»« 100% â†’ 0% (Æ°á»›c tÃ­nh).`;
      if(rate<=5) t += ' \u2013 \u003c=5%/h: Tiáº¿t kiá»‡m/á»•n.';
      else if(rate<=10) t += ' \u2013 5-10%/h: BÃ¬nh thÆ°á»ng.';
      else t += ' \u2013 >10%/h: Hao nhanh.';
    }
    $('#pinNote').textContent=t;
  }
  
  $('#pinStartBtn').onclick=()=>{
    if(battery && pinAutoMode){
      $('#pinStart').value = Math.round(battery.level*100);
    }
    pinStartTS=Date.now(); 
    clearInterval(pinTimerId); 
    pinTimerId=setInterval(()=>{ 
      updatePinTimer(); 
      if(pinAutoMode && battery){
        $('#pinNow').value = Math.round(battery.level*100);
      }
      refreshPin(); 
    },1000); 
    updatePinTimer();
  };
  
  $('#pinMarkBtn').onclick=()=>{
    if(battery && pinAutoMode){
      $('#pinNow').value = Math.round(battery.level*100);
    }
    refreshPin();
  };
  
  $('#pinAutoBtn').onclick=(e)=>{
    pinAutoMode = !pinAutoMode;
    e.currentTarget.textContent = pinAutoMode ? 'Táº¯t tá»± Ä‘á»™ng' : 'Báº­t tá»± Ä‘á»™ng';
    e.currentTarget.setAttribute('aria-pressed', String(pinAutoMode));
    
    if(pinAutoMode && battery){
      $('#pinNow').value = Math.round(battery.level*100);
      if(pinStartTS) refreshPin();
    }
  };

  // ====== FPS METER ======
  const fpsCanvas=$('#fpsCanvas'); const fctx=fpsCanvas.getContext('2d');
  const W=fpsCanvas.width, H=fpsCanvas.height;
  let fpsOn=false, last=performance.now(), samples=[], peak=0, low=999, sim60=false;
  function drawGrid(){
    fctx.clearRect(0,0,W,H); fctx.fillStyle='#0b0f1c'; fctx.fillRect(0,0,W,H);
    fctx.strokeStyle='#1f2a45'; fctx.lineWidth=1; fctx.beginPath();
    for(let y=0;y<=H;y+=25){ fctx.moveTo(0,y); fctx.lineTo(W,y);} for(let x=0;x<=W;x+=50){ fctx.moveTo(x,0); fctx.lineTo(x,H);} fctx.stroke();
    fctx.fillStyle='#9aa6bf'; fctx.fillText('0',2,H-4); fctx.fillText('30',2,H-4- (30*H/240)); fctx.fillText('60',2,H-4-(60*H/240)); fctx.fillText('120',2,H-4-(120*H/240));
  }
  drawGrid();
  function loop(ts){
    if(!fpsOn) return;
    const dt = ts-last; last=ts; const fps = clamp(1000/dt,0,240);
    samples.push(fps); if(samples.length>W) samples.shift();
    peak = Math.max(peak,fps); low=Math.min(low,fps);
    // draw
    drawGrid(); fctx.strokeStyle='#22d3ee'; fctx.beginPath();
    samples.forEach((v,i)=>{ const y = H - (v/240)*H; if(i===0) fctx.moveTo(0,y); else fctx.lineTo(i,y); }); fctx.stroke();
    $('#fpsNow').textContent = fmt(fps);
    const avg = samples.slice(-120).reduce((a,b)=>a+b,0)/Math.max(1,Math.min(120,samples.length));
    $('#fpsAvg').textContent = fmt(avg);
    $('#fpsPeak').textContent= fmt(peak);
    $('#fpsLow').textContent = fmt(low===999?undefined:low);
    if(sim60){ setTimeout(()=>requestAnimationFrame(loop), 1000/60); } else { requestAnimationFrame(loop); }
  }
  $('#btnStartFPS').onclick=()=>{ if(fpsOn) return; fpsOn=true; last=performance.now(); peak=0; low=999; samples=[]; requestAnimationFrame(loop); };
  $('#btnStopFPS').onclick=()=>{ fpsOn=false; };
  $('#btnSim60').onclick=(e)=>{ sim60=!sim60; e.currentTarget.setAttribute('aria-pressed', String(sim60)); };

  // ====== JANK / LOAD ======
  let workers=[]; let ltCount=0; let driftPeak=0; let driftAvg=0; let lagTimer=null; let lastTick=performance.now();
  function startWorkers(n){ stopWorkers(); workers=[]; for(let i=0;i<n;i++){ const blob=new Blob([`
      onmessage=e=>{ function isPrime(x){ if(x<2)return false; for(let i=2;i*i<=x;i++){ if(x%i===0)return false;} return true; }
        let r=0; let k=3; while(true){ for(let j=0;j<5000;j++){ isPrime(k); k+=2; } r++; if(r%200===0) postMessage(r); }
      };`],{type:'application/javascript'});
      const url=URL.createObjectURL(blob); const w=new Worker(url); w.onmessage=()=>{}; workers.push(w); w.postMessage(1);
    }
  }
  function stopWorkers(){ workers.forEach(w=>w.terminate()); workers=[]; }
  $('#btnStartLoad').onclick=()=>{ const lvl=parseInt($('#loadLevel').value,10); startWorkers(lvl); };
  $('#btnStopLoad').onclick=()=>{ stopWorkers(); };
  $('#loadLevel').addEventListener('input',e=>{ const lvl=parseInt(e.target.value,10); if(workers.length) startWorkers(lvl); });

  // Loop lag meter
  function lagLoop(){
    const now=performance.now(); const diff=now-lastTick; lastTick=now; const lag=Math.max(0,diff-100); // expect ~100ms interval below
    $('#lagNow').textContent=fmt(lag);
    $('#lagMeter').style.width=`${clamp(lag,0,200)/200*100}%`;
  }
  lagTimer=setInterval(lagLoop,100);

  // Long Task observer
  try{
    const po=new PerformanceObserver((list)=>{ for(const e of list.getEntries()){ ltCount++; $('#ltCount').textContent=ltCount; } });
    po.observe({entryTypes:['longtask']});
  }catch{}

  // Drift checker (timer accuracy)
  let driftSamples=[]; let driftRef=performance.now();
  setInterval(()=>{
    const now=performance.now(); const expected=driftRef+500; const drift=Math.max(0,now-expected);
    driftRef=now; driftSamples.push(drift); if(drift>driftPeak) driftPeak=drift;
    const len=Math.min(60,driftSamples.length); const avg=driftSamples.slice(-len).reduce((a,b)=>a+b,0)/len; driftAvg=avg;
    $('#driftPeak').textContent=fmt(driftPeak);
    $('#driftAvg').textContent=fmt(driftAvg);
  },500);

  // ====== FISH TANK ======
  const fishTank = $('#fishTank');
  const fishEmojis = ['ğŸŸ', 'ğŸ ', 'ğŸ¡', 'ğŸ¦ˆ', 'ğŸ™', 'ğŸ¦‘', 'ğŸ¦', 'ğŸ¦€', 'ğŸš', 'ğŸŒŠ'];
  let fishCount = 0;
  let autoFishInterval = null;
  let autoFishOn = false;

  function createFish(x, y) {
    const fish = document.createElement('div');
    fish.className = 'fish';
    fish.textContent = fishEmojis[Math.floor(Math.random() * fishEmojis.length)];
    fish.style.left = x + 'px';
    fish.style.top = y + 'px';
    
    const angle = Math.random() * Math.PI * 2;
    const speed = 0.5 + Math.random() * 1;
    const size = 20 + Math.random() * 20;
    fish.style.fontSize = size + 'px';
    
    let px = x;
    let py = y;
    let dir = Math.random() < 0.5 ? 1 : -1; // flip direction
    
    const move = () => {
      px += Math.cos(angle) * speed * dir;
      py += Math.sin(angle) * speed * dir;
      
      // Bounce off walls
      const rect = fishTank.getBoundingClientRect();
      if (px < 0 || px > rect.width - size) {
        dir *= -1;
        px = Math.max(0, Math.min(px, rect.width - size));
      }
      if (py < 0 || py > rect.height - size) {
        dir *= -1;
        py = Math.max(0, Math.min(py, rect.height - size));
      }
      
      fish.style.left = px + 'px';
      fish.style.top = py + 'px';
      fish.style.transform = `scaleX(${dir})`;
      
      requestAnimationFrame(move);
    };
    
    move();
    
    // Auto remove after 30-60 seconds
    setTimeout(() => {
      if (fish.parentNode) {
        fish.style.opacity = '0';
        fish.style.transition = 'opacity 1s';
        setTimeout(() => {
          if (fish.parentNode) {
            fish.remove();
            fishCount--;
            $('#fishCount').textContent = fishCount;
          }
        }, 1000);
      }
    }, 30000 + Math.random() * 30000);
    
    fishTank.appendChild(fish);
    fishCount++;
    $('#fishCount').textContent = fishCount;
  }

  fishTank.addEventListener('click', (e) => {
    const rect = fishTank.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    createFish(x, y);
  });

  fishTank.addEventListener('touchstart', (e) => {
    e.preventDefault();
    const rect = fishTank.getBoundingClientRect();
    const touch = e.touches[0];
    const x = touch.clientX - rect.left;
    const y = touch.clientY - rect.top;
    createFish(x, y);
  });

  $('#btnClearFish').onclick = () => {
    fishTank.innerHTML = '';
    fishCount = 0;
    $('#fishCount').textContent = fishCount;
  };

  $('#btnAutoFish').onclick = (e) => {
    autoFishOn = !autoFishOn;
    e.currentTarget.setAttribute('aria-pressed', String(autoFishOn));
    
    if (autoFishOn) {
      autoFishInterval = setInterval(() => {
        if (fishCount < 50) { // Limit to 50 fish
          const rect = fishTank.getBoundingClientRect();
          const x = Math.random() * rect.width;
          const y = Math.random() * rect.height;
          createFish(x, y);
        }
      }, 1000);
    } else {
      if (autoFishInterval) {
        clearInterval(autoFishInterval);
        autoFishInterval = null;
      }
    }
  };
</script>
</body>
</html>

